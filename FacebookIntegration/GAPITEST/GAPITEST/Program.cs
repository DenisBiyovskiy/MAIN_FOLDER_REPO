using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
using FacebookGraphAPIHelper;
using FacebookGraphAPIHelper.Objects;
using System.Drawing;
using Newtonsoft.Json;
using System.IO;
using System.Security.Cryptography;

namespace GAPITEST
{
    class Program
    {
        static void Main(string[] args)
        {
            string s = "0x7B224461746147726964223A7B2274696C6564436F6E666967223A227B5C22677269645C223A7B5C22726F77735C223A332C5C22636F6C756D6E735C223A32347D2C5C226974656D735C223A5B7B5C2262696E64546F5C223A5C22636E73546578745C222C5C2263617074696F6E5C223A5C22D0A2D0B5D0BAD181D18220D181D0BED0BED0B1D189D0B5D0BDD0B8D18F5C222C5C22747970655C223A5C22746578745C222C5C22706F736974696F6E5C223A7B5C22636F6C756D6E5C223A302C5C22636F6C5370616E5C223A31352C5C22726F775C223A317D2C5C226461746156616C7565547970655C223A312C5C226167677265676174696F6E547970655C223A5C225C222C5C226D65746143617074696F6E506174685C223A5C22D0A2D0B5D0BAD181D18220D181D0BED0BED0B1D189D0B5D0BDD0B8D18F5C222C5C226D657461506174685C223A5C22636E73546578745C222C5C22706174685C223A5C22636E73546578745C222C5C2273657269616C697A656446696C7465725C223A5C227B5C5C5C22636C6173734E616D655C5C5C223A5C5C5C225465727261736F66742E46696C74657247726F75705C5C5C222C5C5C5C226974656D735C5C5C223A7B7D2C5C5C5C226C6F676963616C4F7065726174696F6E5C5C5C223A302C5C5C5C226973456E61626C65645C5C5C223A747275652C5C5C5C2266696C746572547970655C5C5C223A362C5C5C5C226B65795C5C5C223A5C5C5C225C5C5C227D5C222C5C2263617074696F6E436F6E6669675C223A7B5C2276697369626C655C223A66616C73657D7D2C7B5C2262696E64546F5C223A5C22636E7349734563686F5C222C5C2263617074696F6E5C223A5C22D098D181D185D0BED0B4D18FD189D0B5D0B55C222C5C22747970655C223A5C22746578745C222C5C22706F736974696F6E5C223A7B5C22636F6C756D6E5C223A31352C5C22636F6C5370616E5C223A332C5C22726F775C223A327D2C5C226461746156616C7565547970655C223A31322C5C226167677265676174696F6E547970655C223A5C225C222C5C226D65746143617074696F6E506174685C223A5C22D098D181D185D0BED0B4D18FD189D0B5D0B520D181D0BED0BED0B1D189D0B5D0BDD0B8D0B55C222C5C226D657461506174685C223A5C22636E7349734563686F5C222C5C22706174685C223A5C22636E7349734563686F5C222C5C2273657269616C697A656446696C7465725C223A5C227B5C5C5C22636C6173734E616D655C5C5C223A5C5C5C225465727261736F66742E46696C74657247726F75705C5C5C222C5C5C5C226974656D735C5C5C223A7B7D2C5C5C5C226C6F676963616C4F7065726174696F6E5C5C5C223A302C5C5C5C226973456E61626C65645C5C5C223A747275652C5C5C5C2266696C746572547970655C5C5C223A362C5C5C5C226B65795C5C5C223A5C5C5C225C5C5C227D5C222C5C2263617074696F6E436F6E6669675C223A7B5C2276697369626C655C223A747275657D7D2C7B5C2262696E64546F5C223A5C22636E73497344656C6976657265645C222C5C2263617074696F6E5C223A5C22D094D0BED181D182D0B0D0B2D0BBD0B5D0BDD0BE5C222C5C22706F736974696F6E5C223A7B5C22636F6C756D6E5C223A31382C5C22636F6C5370616E5C223A332C5C22726F775C223A327D2C5C226461746156616C7565547970655C223A31322C5C226D657461506174685C223A5C22636E73497344656C6976657265645C222C5C22706174685C223A5C22636E73497344656C6976657265645C222C5C2263617074696F6E436F6E6669675C223A7B5C2276697369626C655C223A747275657D7D2C7B5C2262696E64546F5C223A5C22636E734973526561645C222C5C2263617074696F6E5C223A5C22D09FD180D0BED187D0B8D182D0B0D0BDD0BE5C222C5C22706F736974696F6E5C223A7B5C22636F6C756D6E5C223A32312C5C22636F6C5370616E5C223A332C5C22726F775C223A327D2C5C226461746156616C7565547970655C223A31322C5C226D657461506174685C223A5C22636E734973526561645C222C5C22706174685C223A5C22636E734973526561645C222C5C2263617074696F6E436F6E6669675C223A7B5C2276697369626C655C223A747275657D7D2C7B5C2262696E64546F5C223A5C22437265617465644F6E5C222C5C2263617074696F6E5C223A5C22D094D0B0D182D0B020D181D0BED0B7D0B4D0B0D0BDD0B8D18F5C222C5C22706F736974696F6E5C223A7B5C22636F6C756D6E5C223A32312C5C22636F6C5370616E5C223A332C5C22726F775C223A337D2C5C226F72646572446972656374696F6E5C223A322C5C226F72646572506F736974696F6E5C223A312C5C226461746156616C7565547970655C223A372C5C226D657461506174685C223A5C22437265617465644F6E5C222C5C22706174685C223A5C22437265617465644F6E5C222C5C2263617074696F6E436F6E6669675C223A7B5C2276697369626C655C223A747275657D7D5D7D222C226C6973746564436F6E666967223A227B5C226974656D735C223A5B7B5C2262696E64546F5C223A5C22636E7349734563686F5C222C5C2263617074696F6E5C223A5C22D098D181D185D0BED0B4D18FD189D0B5D0B520D181D0BED0BED0B1D189D0B5D0BDD0B8D0B55C222C5C22706F736974696F6E5C223A7B5C22636F6C756D6E5C223A302C5C22636F6C5370616E5C223A322C5C22726F775C223A317D2C5C226461746156616C7565547970655C223A31322C5C226D657461506174685C223A5C22636E7349734563686F5C222C5C22706174685C223A5C22636E7349734563686F5C222C5C226F72646572446972656374696F6E5C223A5C225C222C5C226F72646572506F736974696F6E5C223A5C225C227D2C7B5C2262696E64546F5C223A5C22636E73546578745C222C5C2263617074696F6E5C223A5C22D0A2D0B5D0BAD181D18220D181D0BED0BED0B1D189D0B5D0BDD0B8D18F5C222C5C22706F736974696F6E5C223A7B5C22636F6C756D6E5C223A322C5C22636F6C5370616E5C223A31362C5C22726F775C223A317D2C5C226461746156616C7565547970655C223A312C5C226D657461506174685C223A5C22636E73546578745C222C5C22706174685C223A5C22636E73546578745C222C5C226F72646572446972656374696F6E5C223A5C225C222C5C226F72646572506F736974696F6E5C223A5C225C227D2C7B5C2262696E64546F5C223A5C22636E73497344656C6976657265645C222C5C2263617074696F6E5C223A5C22D094D0BED181D182D0B0D0B2D0BBD0B5D0BDD0BE5C222C5C22706F736974696F6E5C223A7B5C22636F6C756D6E5C223A31382C5C22636F6C5370616E5C223A332C5C22726F775C223A317D2C5C226461746156616C7565547970655C223A31322C5C226D657461506174685C223A5C22636E73497344656C6976657265645C222C5C22706174685C223A5C22636E73497344656C6976657265645C222C5C226F72646572446972656374696F6E5C223A5C225C222C5C226F72646572506F736974696F6E5C223A5C225C227D2C7B5C2262696E64546F5C223A5C22636E734973526561645C222C5C2263617074696F6E5C223A5C22D09FD180D0BED187D0B8D182D0B0D0BDD0BE5C222C5C22706F736974696F6E5C223A7B5C22636F6C756D6E5C223A32312C5C22636F6C5370616E5C223A332C5C22726F775C223A317D2C5C226461746156616C7565547970655C223A31322C5C226D657461506174685C223A5C22636E734973526561645C222C5C22706174685C223A5C22636E734973526561645C222C5C226F72646572446972656374696F6E5C223A322C5C226F72646572506F736974696F6E5C223A317D5D7D222C226B6579223A22436F6E74616374506167655632636E734D657373656E6765724D6573736167657344657461696C222C22697354696C6564223A66616C73652C2274797065223A226C6973746564227D2C226973436F6C6C6170736564223A66616C73652C2270726F66696C6543756C747572654964223A2231613737386533662D306138652D653131312D383461332D303031353564303534633033222C2274696C6564436F6C756D6E73436F6E666967223A227B7D222C226C6973746564436F6C756D6E73436F6E666967223A227B7D222C226B6579223A22436F6E74616374506167655632636E734D657373656E6765724D6573736167657344657461696C227D";
            convertFromDB(s);
            
            //AllCombinedBuilder.build();            

            //runTest();
        }

        public static void runTest() 
        {
            //uphUserId	uphPageToken	uphAppSecret	uphAppId	uphPageId
            //1091321741005034	EAAFFru3lRl0BAO8M52suZA1bDDuU4Sofsl85QZAVB3erojkZCTYBhnH6WXIQYl8gdxrbT57xZBrq1ZBOyiyUprYu1ERq1BMwmVKicDoUehDNkp66n6NSihqsZBjMV7eLV7yNZAZCwniekMYut2c8u12B9Dyb7z8X4HKIxp9gmPLZAmQZDZD	81f78efeb40c979e3c029d9f8c533212	358092594562653	1369352673095644
            Tools.ClearFile();
            //connection params
            string appID = "391897567851647";
            string appSecret = "52d25a29757683b9e490cb0608cdc0c2";
            string exToken = "EAAFkbcNR9H8BAGmAqvVyrE36KHUlPWvQu0pvGjyLf6QwvZBygj2aU0xyegduVteIt98ZAVulpWbOq3ZAPLQg60Qfy5VL6zg3gOhqydpnfxPpM7KbJgEAB6EcOrBzflZAZByYHDrrqqoJZAaRdpJ3ZAqZArLbBA5HVvIZD";
            string pageId = "132854376755291";
            string accToken = "";
            string pageToken = "";
            GraphAPIHelper gepiHelper = new GraphAPIHelper(appID, appSecret, exToken);

            //BaseResponse res = gepiHelper.GetLongLivedAccessToken(exToken, out accToken);
            //Accounts accs;
            //res = gepiHelper.GetUserAccounts(accToken, out accs);
            //Tools.WriteToFile(accs);
            Posts posts;
            //gepiHelper.GetTopPosts(pageId, accToken, out posts);
            //Tools.WriteToFile(posts);
            //res = gepiHelper.GetPageAccessToken(out pageToken);
            //Tools.WriteToFile(pageToken);
            //----- gepiHelper.PostMessage(pageId, accs.data[0].access_token, "autogenerated message 4");
            //Tools.ClearFile();
            //var url = "https://www.facebook.com/IntegrationTest-1369352673095644/";
            //var a = gepiHelper.GetPageByUrl(url);
            //var pic = gepiHelper.LoadPictureFromUrl(a.picture.data.url);
            //Tools.WriteToFile(a);
            //Tools.WriteToFile(pic);
            //var br = gepiHelper.GetPageByUrl("https://www.facebook.com/TestIra-1491247927554351/");
            //Tools.WriteStringToFile(br);

            var br = gepiHelper.GetAllPosts("132854376755291", exToken, out posts);
            /*Tools.WriteStringToFile(posts.data.Count);
            string postsRCount = "";
            var flag = true;
            for (int i = 0; i < posts.data.Count; i++)
            {
                var count = 0;
                if (posts.data[i].reactions != null)
                {
                    postsRCount += i + " " + posts.data[i].reactions.data.Count + "\n";
                    count = posts.data[i].reactions.data.Count;
                }
                if (count > 1000 && flag)
                {
                    Tools.WriteToFile(posts.data[i].reactions);
                    flag = false;
                }
            }*/
            //Tools.WriteToFile(posts);
        }

        public static void convertFromDB(string s)
        {
            //Парсим данные из бд.
            byte[] b = StringToByteArray(s);
            string encodedString = Convert.ToBase64String(b);
            byte[] data = Convert.FromBase64String(encodedString);
            string decodedString = Encoding.UTF8.GetString(data);
            Tools.WriteToFile(encodedString, false);
            Tools.WriteToFile(decodedString, true);
        }
        public static byte[] StringToByteArray(string hex)
        {
            hex = hex.Substring(2, hex.Length - 2);
            return Enumerable.Range(0, hex.Length)
                             .Where(x => x % 2 == 0)
                             .Select(x => Convert.ToByte(hex.Substring(x, 2), 16))
                             .ToArray();
        }
     }
}
